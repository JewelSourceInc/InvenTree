<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>InvenTree Bulk Delete Parts</title>
  <style>
    body { font-family: sans-serif; margin: 20px; max-width: 800px; }
    label { display: block; margin: 8px 0 4px; }
    input, textarea, button { margin-bottom: 8px; font-family: inherit; }
    textarea { width: 100%; height: 100px; }
    .section { margin-top: 20px; }
    .hint { font-size: 12px; color: #666; }
    #log { width: 100%; height: 200px; font-size: 12px; }
    button.danger { background: #d32f2f; color: #fff; border: none; padding: 8px 16px; cursor: pointer; }
    button.danger:hover { background: #b71c1c; }
    button.primary { background: #2196f3; color: #fff; border: none; padding: 8px 16px; cursor: pointer; }
    button.primary:hover { background: #1976d2; }
    button { padding: 6px 12px; }
    .success { color: #4caf50; }
    .error { color: #f44336; }
    #auth-section { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; background: #f9f9f9; }
  </style>
</head>
<body>
  <h1>InvenTree Bulk Delete Parts</h1>
  <p><em>Works with ALL InvenTree versions - Single login for all operations</em></p>

  <div id="auth-section" class="section">
    <h2>ğŸ” Login (Once)</h2>
    <label>InvenTree Base URL</label>
    <input id="base-url" type="text" size="40" value="https://inventree.jsistock.com" />
    <br>
    <label>Username: <input id="username" type="text" size="20" /></label>
    <label>Password: <input id="password" type="password" size="20" /></label>
    <br>
    <button id="login-btn" class="primary">Login & Test Connection</button>
    <span id="auth-status"></span>
  </div>

  <div class="section">
    <h2>Part IDs to Delete</h2>
    <label>Enter IDs/ranges (one per line):</label>
    <textarea id="id-input" placeholder="Examples:
8
9
10
7-12
15,20-25">8
9
10</textarea>
    <p class="hint"><strong>Format:</strong> <code>8</code> or <code>7-12</code> or <code>15,20-25</code></p>
  </div>

  <div class="section">
    <h2>Actions</h2>
    <button id="preview-btn" disabled>ğŸ” Preview IDs</button>
    <button id="deactivate-btn" disabled style="background: #ff9800; color: #fff;">ğŸ“´ Bulk Deactivate</button>
    <button id="delete-btn" class="danger" disabled>ğŸ—‘ï¸ Delete Parts</button>
  </div>

  <div class="section">
    <h2>Results</h2>
    <textarea id="log" readonly placeholder="Login first, then use buttons above..."></textarea>
  </div>

  <script>
    // Global auth state
    let authToken = null;
    let baseUrl = '';

    const baseUrlInput = document.getElementById('base-url');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const authStatus = document.getElementById('auth-status');
    const idInput = document.getElementById('id-input');
    const previewBtn = document.getElementById('preview-btn');
    const deactivateBtn = document.getElementById('deactivate-btn');
    const deleteBtn = document.getElementById('delete-btn');
    const logArea = document.getElementById('log');

    function log(msg, type = '') {
      const timestamp = new Date().toLocaleTimeString();
      logArea.value += `[${timestamp}] ${msg}\n`;
      logArea.scrollTop = logArea.scrollHeight;
    }

    function updateButtons() {
      const enabled = !!authToken;
      previewBtn.disabled = !enabled;
      deactivateBtn.disabled = !enabled;
      deleteBtn.disabled = !enabled;
    }

    function setAuthStatus(msg, isError = false) {
      authStatus.textContent = msg;
      authStatus.style.color = isError ? '#f44336' : '#4caf50';
    }

    // Parse IDs/ranges from textarea
    function parseIds(text) {
      const ids = new Set();
      text.split(/[\n,]/).forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;
        
        if (trimmed.includes('-')) {
          const [start, end] = trimmed.split('-').map(s => parseInt(s.trim()));
          if (!isNaN(start) && !isNaN(end) && end >= start) {
            for (let i = start; i <= end; i++) ids.add(i);
          }
        } else {
          const id = parseInt(trimmed);
          if (!isNaN(id)) ids.add(id);
        }
      });
      return Array.from(ids).sort((a, b) => a - b);
    }

    // Make authenticated API call
    async function apiCall(url, options = {}) {
      if (!authToken) throw new Error('Not logged in');
      
      const res = await fetch(url, {
        ...options,
        headers: {
          'Authorization': authToken,
          'Accept': 'application/json',
          ...options.headers
        }
      });
      return res;
    }

    // LOGIN - Single authentication for all operations
    loginBtn.addEventListener('click', async () => {
      const url = baseUrlInput.value.trim();
      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();

      if (!url || !username || !password) {
        return log('Enter URL, username, and password', 'error');
      }

      try {
        log('Testing connection...');
        const auth = 'Basic ' + btoa(username + ':' + password);
        
        // Test API connection
        const testRes = await fetch(`${url.replace(/\/+$/, '')}/api/part/?limit=1`, {
          headers: { 'Authorization': auth }
        });

        if (!testRes.ok) {
          throw new Error(`API test failed: ${testRes.status}`);
        }

        // Store auth globally
        authToken = auth;
        baseUrl = url.replace(/\/+$/, '');
        
        setAuthStatus('âœ… Logged in successfully', false);
        log('âœ… Login successful - ready for bulk operations', 'success');
        updateButtons();
        
      } catch (err) {
        setAuthStatus('âŒ Login failed: ' + err.message, true);
        log('âŒ Login failed: ' + err.message, 'error');
        authToken = null;
      }
    });

    // PREVIEW - Show what will be targeted
    previewBtn.addEventListener('click', async () => {
      const ids = parseIds(idInput.value);
      if (!ids.length) return log('No valid IDs found', 'error');
      
      log(`ğŸ” Previewing ${ids.length} IDs: ${ids.slice(0, 10).join(', ')}${ids.length > 10 ? '...' : ''}`);
      
      // Show details for first 5 parts
      for (let i = 0; i < Math.min(5, ids.length); i++) {
        try {
          const res = await apiCall(`${baseUrl}/api/part/${ids[i]}/`);
          if (res.ok) {
            const part = await res.json();
            log(`  ID ${part.pk}: ${part.IPN} - ${part.name.substring(0, 30)}${part.name.length > 30 ? '...' : ''}`);
          }
        } catch (e) {
          log(`  ID ${ids[i]}: Not found`);
        }
      }
    });

    // BULK DEACTIVATE
    deactivateBtn.addEventListener('click', async () => {
      const ids = parseIds(idInput.value);
      if (!ids.length) return log('No valid IDs', 'error');
      
      if (!confirm(`ğŸ“´ Deactivate ${ids.length} parts?`)) return;
      
      log(`ğŸ“´ Deactivating ${ids.length} parts...`);
      let success = 0, failed = 0;
      
      for (const id of ids) {
        try {
          const res = await apiCall(`${baseUrl}/api/part/${id}/`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ active: false })
          });
          
          if (res.ok) {
            log(`ğŸ“´ ID ${id} deactivated`, 'success');
            success++;
          } else {
            const text = await res.text();
            log(`âš ï¸ ID ${id}: ${res.status} - ${text.slice(0, 50)}`, 'error');
            failed++;
          }
        } catch (err) {
          log(`âŒ ID ${id}: ${err.message}`, 'error');
          failed++;
        }
      }
      
      log(`ğŸ“Š Deactivate: ${success} success, ${failed} failed`);
    });

    // BULK DELETE
    deleteBtn.addEventListener('click', async () => {
      const ids = parseIds(idInput.value);
      if (!ids.length) return log('No valid IDs', 'error');
      
      if (!confirm(`ğŸ—‘ï¸ Permanently delete ${ids.length} parts?`)) return;
      
      log(`ğŸ—‘ï¸ Deleting ${ids.length} parts...`);
      let success = 0, failed = 0;
      
      for (const id of ids) {
        try {
          const res = await apiCall(`${baseUrl}/api/part/${id}/`, {
            method: 'DELETE'
          });
          
          if (res.ok || res.status === 204) {
            log(`âœ… ID ${id} DELETED`, 'success');
            success++;
          } else {
            const text = await res.text();
            log(`âŒ ID ${id}: ${res.status} "${text}"`, 'error');
            failed++;
          }
        } catch (err) {
          log(`âŒ ID ${id}: ${err.message}`, 'error');
          failed++;
        }
      }
      
      log(`ğŸ¯ FINAL: ${success} deleted, ${failed} failed`);
      if (failed) log('ğŸ’¡ Try: 1) Deactivate first 2) Remove stock 3) Check BOMs');
    });
  </script>
</body>
</html>